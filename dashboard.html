<!DOCTYPE html>
<html>
<head>
<title>TCS Study Tracker</title>
<link rel="stylesheet" href="/static/style.css">
<link rel="manifest" href="/static/manifest.json">
<meta name="theme-color" content="#0b1f5e">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<h2>üìä TCS 15-Day Study Tracker</h2>

<div class="chart-container">
    <canvas id="chart"></canvas>
</div>
<div id="alertBox" class="browser-alert" style="display:none;">
    ‚ö†Ô∏è You have missed today‚Äôs study task!
</div>

<form action="/reset-today" method="post" onsubmit="return confirmTodayReset();">
    <button class="reset-today-btn">üîÅ Reset Today</button>
</form>

<form action="/reset" method="post" onsubmit="return confirmReset();">
    <button class="reset-btn">üîÑ Reset 15-Day Plan</button>
</form>
<form action="/reset-day" method="post" onsubmit="return confirmDayReset();">
    <select name="day" required>
        {% for d in tasks %}
            <option value="{{ d[0] }}">Day {{ d[0] }} ‚Äì {{ d[1] }}</option>
        {% endfor %}
    </select>
    <button class="reset-day-btn">üîÅ Reset Selected Day</button>
</form>
<form action="/undo-reset" method="post">
    <button class="undo-btn">‚Ü© Undo Last Reset</button>
</form>

<table>
<tr>
<th>Day</th><th>Task</th><th>Status</th><th>Action</th>
</tr>

{% for d in tasks %}
<tr>
<td>Day {{ d[0] }}</td>
<td>{{ d[1] }}</td>
<td>
<div class="bar {{ d[2]|lower }}"></div>
{{ d[2] }}
</td>
<td>
{% if d[2] != "Completed" %}
<form method="post">
<input type="hidden" name="day" value="{{ d[0] }}">
<button>Done</button>
</form>
{% endif %}
</td>
</tr>
{% endfor %}
</table>

<h3>Weekly Progress: {{ percent }}%</h3>
<audio id="alertSound" src="/static/alert.mp3"></audio>

<script>
    function showBrowserAlert(message) {
    // On-screen alert
    const box = document.getElementById("alertBox");
    box.innerText = message;
    box.style.display = "block";

    // üîä Play sound
    const sound = document.getElementById("alertSound");
    sound.play().catch(() => {});

    // üîî Browser notification
    if ("Notification" in window) {
        if (Notification.permission === "granted") {
            navigator.serviceWorker.ready.then(reg => {
    reg.showNotification("üìò TCS Study Alert", {
        body: message,
        icon: "/static/icon-192.png",
        badge: "/static/icon-192.png"
    });
});
        } else if (Notification.permission !== "denied") {
            Notification.requestPermission();
        }
    }
}
if ("serviceWorker" in navigator && "Notification" in window) {
    navigator.serviceWorker.register("/static/sw.js").then(() => {
        Notification.requestPermission();
    });
}
    function confirmTodayReset() {
    return confirm(
        "Reset ONLY today‚Äôs task?\n\nOther days will not be affected."
    );
}
    function confirmReset() {
    return confirm(
        "‚ö†Ô∏è Are you sure?\n\nThis will reset ALL progress for the 15-day plan."
    );
}
function confirmDayReset() {
    return confirm(
        "Are you sure you want to reset the selected day only?"
    );
}
const completed = {{ completed }};
const missed = {{ missed }};
const total = completed + missed;
const percent = total ? Math.round((completed / total) * 100) : 0;

// Custom plugin for center text
const centerTextPlugin = {
    id: 'centerText',
    beforeDraw(chart) {
        const { width } = chart;
        const { height } = chart;
        const ctx = chart.ctx;
        ctx.restore();

        const fontSize = (height / 120).toFixed(2);
        ctx.font = `bold ${fontSize}em Arial`;
        ctx.textBaseline = "middle";
        ctx.fillStyle = "#0b1f5e";

        const text = percent + "%";
        const textX = Math.round((width - ctx.measureText(text).width) / 2);
        const textY = height / 2 - 10;

        ctx.fillText(text, textX, textY);

        ctx.font = "14px Arial";
        ctx.fillStyle = "#555";
        ctx.fillText(
            "Completed",
            width / 2 - 35,
            height / 2 + 15
        );

        ctx.save();
    }
};

const ctx = document.getElementById("chart");

new Chart(ctx, {
    type: "doughnut",
    data: {
        labels: ["Completed", "Missed"],
        datasets: [{
            data: [completed, missed],
            backgroundColor: ["#36a2eb", "#ff6384"],
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: "70%",
        plugins: {
            legend: {
                position: "top"
            }
        }
    },
    plugins: [centerTextPlugin]
});
</script>
{% if missed_today %}
<script>
showBrowserAlert("You missed today's study task. Please complete it!");
</script>
{% endif %}

</body>
</html>
